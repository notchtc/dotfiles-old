#!/usr/bin/env sh
# Variables that are used to indicate if a wm was installed
awesome=0; bspwm=0

# FUNCTIONS
# Install something
install() {	
	for i in $1; do
		printf "\nInstalling \033[32m%s\033[0m" "$i"
		sudo xbps-install -y "$i" >> /dev/null
	done
}

# Install something with asking
installasking() {
	name="$1"
	dependencies="$2"
	variable="${3:-default}"
	printf "\nDo you want to install \033[32m%s\033[0m? [\033[1;32mY\033[0m/\033[31mN\033[0m] " "$name"
	read -r answer
	if [ "$answer" != "${answer#[Yy]}" ]; then    
		export "$variable"=1
		install "$dependencies"
	fi
}

# A nice thing to divide stuff into sections
div() {	printf "\n\033[1;32m%s\n\033[0m%s\n------------------------------" "$1" "$2"; }

# Sets the wm
setwm() {
	# If file exists just replace exec line
	if [ -s "$HOME/.xinitrc" ]; then sed -i "s/exec.*/exec $1/" "$HOME/.xinitrc"
	# If file doesn't exist create the file with the exec line
	else echo "exec $1" >> "$HOME/.xinitrc"; fi
}

# Sets wm depending on variable
whichwm() {	
	if [ "$1" -eq "$2" ]; then setwm awesome
	elif [ "$3" -eq "$4" ]; then setwm bspwm; fi
}

# THE REAL DEAL
distro=$(lsb_release -s -c)
if [ "$distro" = "void" ]; then
	printf "\033[32mWelcome!\nThis script will download my dotfiles and programs related with it"
else
	printf "\033[31mYour distro isn't supported!"
	exit
fi
div "THINGS THAT ARE REQUIRED" "Everything requires this (the dotfiles/script)" 
install "font-hack-ttf git rcm xorg"
printf "\n"

div "DOTFILES" "Getting the thing"
echo "Downloading dotfiles"
git clone "https://gitlab.com/cha0t1c/dotfiles.git" "$HOME/.dotfiles" >> /dev/null

printf "\nSymlinking dotfiles\n"
rcup

printf "\nRemoving useless stuff\n"
rm -r "$HOME/.images" "$HOME/.LICENSE" "$HOME/.README.md" "$HOME/.install"

div "WINDOW MANAGERS" "Without this you won't have a gui"
# Ask to install awesome | Dependencies | Variable to check if it has been installed
installasking awesome "awesome alacritty picom maim xclip pamixer playerctl sxiv" awesome

# Ask to install bspwm | Dependencies | Variable to check if it has been installed
installasking bspwm "bspwm sxhkd alacritty dunst maim nitrogen pamixer picom playerctl polybar rofi xbacklight xclip" bspwm
printf "\n"

div "ADDITIONAL PROGRAMS" "Things that I use"
other="firefox gimp mpv sxiv neovim keepassxc OTPClient lxappearance"
for i in $other; do installasking "$i" "$i"; printf "\n"; done

# Fish is seperate so it downloads bat and lsd only when fish is installed
installasking fish "fish-shell bat lsd"
printf "\n"

div "THE END" "The installation is nearly complete"
printf "\nUpdating packages\n"
sudo xbps-install -Su

printf "\n"

# If the user has downloaded both it asks which wm to use
if [ "$awesome" -eq 1 ] && [ "$bspwm" -eq 1 ]; then
	printf "Which \033[32mwindow manager do you want to use? \033[31m0 - none\033[0m \033[1;32m1 - awesome 2 - bspwm\033[0m "
	read -r answer	
	whichwm "$answer" 1 "$answer" 2
else
	whichwm "$awesome" 1 "$bspwm" 1
fi;	

# Message about installing Hack Nerd Font
printf "\n\033[1;31mYou also need to install the Hack Nerd Font!\033[0m
\033[1;33mcurl -O -o Hack.zip \"https://github.com/ryanoasis/nerd-fonts/releases/download/v2.1.0/Hack.zip\"\033[0m
To unpack it you maybe also want to use for example: p7zip.
\033[1;33m7z x Hack.zip\033[0m
And move the files of the font to \"\$HOME/.local/share/fonts\".
Do \033[1;33mmkdir \$HOME/.local/share/fonts\033[0m if it doesn't exist.
\033[1;33mmv Hack* \"\$HOME/.local/share/fonts\"\033[0m"
